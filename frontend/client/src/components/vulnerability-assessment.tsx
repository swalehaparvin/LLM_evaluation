import { useQuery } from "@tanstack/react-query";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Progress } from "@/components/ui/progress";
import { Shield, AlertTriangle, CheckCircle, AlertCircle } from "lucide-react";
import { api, type EvaluationResult } from "@/lib/api";

const severityConfig = {
  critical: {
    icon: AlertTriangle,
    className: "vulnerability-critical",
    color: "text-red-600",
    bgColor: "bg-red-500",
  },
  high: {
    icon: AlertCircle,
    className: "vulnerability-high", 
    color: "text-orange-600",
    bgColor: "bg-orange-500",
  },
  medium: {
    icon: AlertCircle,
    className: "vulnerability-medium",
    color: "text-yellow-600", 
    bgColor: "bg-yellow-500",
  },
  low: {
    icon: CheckCircle,
    className: "vulnerability-low",
    color: "text-green-600",
    bgColor: "bg-green-500",
  },
};

export default function VulnerabilityAssessment() {
  const { data: recentResults } = useQuery<EvaluationResult[]>({
    queryKey: ['/api/recent-results', { limit: 50 }],
    refetchInterval: 10000,
  });

  // Group results by severity and calculate scores
  const vulnerabilityData = recentResults?.reduce((acc, result) => {
    const severity = result.impactSeverity as keyof typeof severityConfig;
    if (!acc[severity]) {
      acc[severity] = { count: 0, totalScore: 0, failed: 0 };
    }
    acc[severity].count++;
    acc[severity].totalScore += result.vulnerabilityScore;
    if (!result.passed) {
      acc[severity].failed++;
    }
    return acc;
  }, {} as Record<string, { count: number; totalScore: number; failed: number }>);

  // Calculate overall security score
  const overallScore = recentResults?.length
    ? recentResults.reduce((sum, result) => sum + (result.compositeScore || 0), 0) / recentResults.length
    : 0;

  const severityEntries = Object.entries(vulnerabilityData || {}).sort((a, b) => {
    const order = ['critical', 'high', 'medium', 'low'];
    return order.indexOf(a[0]) - order.indexOf(b[0]);
  });

  return (
    <Card>
      <CardHeader>
        <CardTitle className="flex items-center">
          <Shield className="h-5 w-5 mr-2 text-primary" />
          Vulnerability Assessment
        </CardTitle>
      </CardHeader>
      <CardContent className="space-y-4">
        {severityEntries.length > 0 ? (
          <div className="space-y-4">
            {severityEntries.map(([severity, data]) => {
              const config = severityConfig[severity as keyof typeof severityConfig];
              const Icon = config.icon;
              const avgScore = data.count > 0 ? data.totalScore / data.count : 0;
              
              return (
                <div
                  key={severity}
                  className={`flex items-center justify-between p-4 border rounded-lg ${config.className}`}
                >
                  <div className="flex items-center">
                    <div className={`w-3 h-3 rounded-full mr-3 ${config.bgColor}`} />
                    <div>
                      <p className="font-medium capitalize">{severity.replace('_', ' ')}</p>
                      <p className="text-sm opacity-80">
                        {data.failed} vulnerabilities detected
                      </p>
                    </div>
                  </div>
                  <div className="text-right">
                    <p className={`text-2xl font-bold ${config.color}`}>
                      {Math.round(avgScore)}
                    </p>
                    <p className="text-xs opacity-70">Risk Score</p>
                  </div>
                </div>
              );
            })}

            <div className="mt-6 pt-4 border-t border-gray-200">
              <div className="flex justify-between items-center mb-2">
                <span className="text-sm font-medium text-gray-700">Overall Security Score</span>
                <span className="text-lg font-bold text-gray-900">{Math.round(overallScore)}/100</span>
              </div>
              <Progress value={overallScore} className="h-3" />
            </div>
          </div>
        ) : (
          <div className="text-center py-8">
            <Shield className="h-12 w-12 text-gray-300 mx-auto mb-4" />
            <p className="text-gray-500">No vulnerability data available</p>
            <p className="text-sm text-gray-400">Run evaluations to see vulnerability assessment</p>
          </div>
        )}
      </CardContent>
    </Card>
  );
}
